<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Anuncio del Paciente</title>
    <link rel="stylesheet" href="/static/css/anuncios.css">
</head>

<body style="display:block !important;">


<div class="an-wrapper">
    <div class="an-card">
    <h2>{{ 'Editar anuncio' if anuncio else 'Nuevo anuncio' }}</h2>

    <form method="POST" action="/paciente/anuncios/guardar" enctype="multipart/form-data">

        {% if anuncio %}
            <input type="hidden" name="idAnuncio" value="{{ anuncio.idAnuncio }}">
        {% endif %}

        <label>Imagen del anuncio</label>
        <input type="file" id="input_imagen" name="imagen" accept="image/*">

        <p>
            <img id="imagen_preview" src="{{ anuncio.Imagen if anuncio and anuncio.Imagen else '' }}" style="max-width:100%; margin-top:10px;" {% if not (anuncio and anuncio.Imagen) %}hidden{% endif %}>
        </p>

        <label>DescripciÃ³n</label>
        <textarea name="descripcion" rows="4" required>{{ anuncio.Descripcion if anuncio else '' }}</textarea>

        <label>URL destino</label>
        <input type="text" name="url" placeholder="Ejemplo: sanacionalternativa.com" value="{{ anuncio.URLAnuncio if anuncio else '' }}" required>

        <label>Fecha inicio vigencia</label>
        <input type="date" class="readonly" readonly
               value="{{ anuncio.FechaInicioVigencia if anuncio else '' }}">

        <label>Fecha fin vigencia</label>
        <input type="date" class="readonly" readonly
               value="{{ anuncio.FechaFinVigencia if anuncio else '' }}">

        <button type="submit">
            ðŸ’¾ Guardar anuncio
        </button>
    </form>
    </div>
</div>

</body>
</html>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const input = document.getElementById('input_imagen');
    const preview = document.getElementById('imagen_preview');
    if (!input || !preview) return;

    input.addEventListener('change', function(){
        const file = this.files && this.files[0];
        if (!file) return;
        if (window.URL && URL.createObjectURL){
            const objUrl = URL.createObjectURL(file);
            preview.src = objUrl;
            preview.style.display = 'block';
            preview.onload = function(){ URL.revokeObjectURL(objUrl); };
        } else {
            const reader = new FileReader();
            reader.onload = function(e){ preview.src = e.target.result; preview.style.display = 'block'; };
            reader.readAsDataURL(file);
        }
    });

    // Normalizar URL antes de enviar el formulario
    const form = document.querySelector('form[action="/paciente/anuncios/guardar"]');
    if (form) {
        const inputUrl = form.querySelector('input[name="url"]');
        function normalize(u) {
            u = (u||'').trim();
            if (!u) return '';
            if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(u)) u = 'https://' + u;
            try { return new URL(u).href; } catch { return u; }
        }
        form.addEventListener('submit', function(){
            if (inputUrl) inputUrl.value = normalize(inputUrl.value);
        });
    }
});
</script>
