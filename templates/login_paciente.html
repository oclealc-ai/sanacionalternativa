<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Paciente</title>

    <link rel="stylesheet" href="/static/css/sanacion.css">

    <style>
        body {
            margin: 0;
            background: url('/static/img/fondo03.jpg') no-repeat center center fixed;
            background-size: cover;
        }

        .container {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.20);
            width: 90%;
            max-width: 400px;
            margin: 40px auto;
        }
    </style>

</head>

<body>

<div class="container">
    
    <h2 style="text-align:center;">
        Acceso de Paciente 
    </h2>

    <p style="text-align:center; color:#28a745; font-weight:bold;">
        Empresa <br>
        {{ empresa }}
    </p>

    <label for="telefono"> Ingresa tu n煤mero para recibir c贸digo:</label>
    <input type="tel" id="telefono" placeholder="Ejemplo: 8112345678" required>
        
    <button onclick="enviarCodigo()">Enviar el c贸digo</button>
    
    <div id="cajaCodigo" style="display:none; margin-top:20px;">
        <h3>Validar C贸digo</h3>
        
        <input type="text" id="codigo"
               maxlength="6"
               placeholder="C贸digo recibido"
               inputmode="numeric">

        <button onclick="validarCodigo()">Validar</button>
    </div>

    <div id="mensaje" class="error-message" style="display:none;"></div>

</div>

<script>
function enviarCodigo() {
    let telefono = document.getElementById("telefono").value.trim();
    
    if (telefono.length < 10) {
        mostrar("N煤mero es inv谩lido");
        return;
    }

    // Obtener la empresa de la URL: /empresa/<id>/paciente/login
    const urlParts = window.location.pathname.split("/");
    const idEmpresa = urlParts[2]; // posici贸n 2 = idEmpresa

    fetch(`/paciente/empresa/${idEmpresa}/auth/login`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({telefono, canal: "sms"})
    })
    .then(r => r.json())
    .then(data => {

        if (data.message === "C贸digo enviado") {
            document.getElementById("cajaCodigo").style.display = "block";
            mostrar("C贸digo enviado por SMS. Revisa tu tel茅fono.", false);
            
            // Guardamos temporalmente el n煤mero
            sessionStorage.setItem("telefono_login", telefono);
            sessionStorage.setItem("idEmpresa_login", idEmpresa);
        }
        else if (data.error === "no_encontrado") {
            //  Si el tel茅fono NO existe, vamos al alta de paciente
            window.location.href = `/empresa/${idEmpresa}/paciente/alta?telefono=${telefono}`;
        }
        else {
            mostrar("Error: " + (data.error || "Desconocido"));
        }
    })
    .catch(err => {
        console.error(err);
        mostrar("Error enviando c贸digo.");
    });
}

function validarCodigo() {
    let codigo = document.getElementById("codigo").value.trim();
    let telefono = sessionStorage.getItem("telefono_login");
    let idEmpresa = sessionStorage.getItem("idEmpresa_login");

    if (!codigo || codigo.length !== 6) {
        mostrar("C贸digo inv谩lido");
        return;
    }

    fetch("/paciente/validar_codigo_empresa", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({telefono, codigo, idEmpresa})
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            // Redirigir al men煤 del paciente de esta empresa
            window.location.href = `/empresa/${idEmpresa}/paciente/menu`;
        } else {
            mostrar("C贸digo incorrecto o expirado.");
        }
    })
    .catch(err => {
        console.error(err);
        mostrar("Error validando c贸digo.");
    });
}

function mostrar(msg, error = true){
    let div = document.getElementById("mensaje");
    div.style.display = "block";
    div.textContent = msg;

    div.className = error ? "error-message" : "success-message";
}

</script>

</body>
</html>
