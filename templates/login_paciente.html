<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Paciente</title>

    <link rel="stylesheet" href="/static/css/sanacion.css">

    <style>
        body {
            margin: 0;
            background: url('/static/img/fondo03.jpg') no-repeat center center fixed;
            background-size: cover;
        }

        .container {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.20);
            width: 90%;
            max-width: 400px;
            margin: 40px auto;
        }
    </style>

</head>

<body>

<div class="container">
    
    <p style="text-align:center; color:#28a745; font-weight:bold;">
        <br> {{ empresa }}
    </p>

    <label for="telefono"> Ingresa tu n煤mero para recibir c贸digo:</label>
    <br> <br>
    <input type="tel" id="telefono" placeholder="Ejemplo: 8112345678" required>
        
    <button onclick="enviarCodigo()">Enviar c贸digo</button>
    
    <div id="cajaCodigo" style="display:none; margin-top:20px;">
        <h3>Validar C贸digo</h3>
        
        <input type="text" id="codigo"
               maxlength="6"
               placeholder="C贸digo recibido"
               inputmode="numeric">

        <button onclick="validarCodigo()">Validar</button>
    </div>

    <div id="mensaje" class="error-message" style="display:none;"></div>

</div>

<script>
function enviarCodigo() {
    let telefono = document.getElementById("telefono").value.trim();
    
    if (telefono.length < 10) {
        mostrar("N煤mero es inv谩lido");
        return;
    }

    let idEmpresa = null;
    
    // Intentar extraer de la ruta
    const urlParts = window.location.pathname.split("/");
    if (urlParts.length >= 3 && urlParts[1] === "empresa") {
        idEmpresa = urlParts[2];
    }
    
    // Si no lo encontr贸, intentar del query parameter
    if (!idEmpresa) {
        const params = new URLSearchParams(window.location.search);
        idEmpresa = params.get("empresa") || "1"; // Default a 1
    }
    
    console.log("URL:", window.location.href);
    console.log("idEmpresa extra铆do:", idEmpresa);
    console.log("Fetch a:", `/paciente/empresa/${idEmpresa}/auth/login`);
    
    fetch(`/paciente/empresa/${idEmpresa}/auth/login`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({telefono, canal: "sms"})
    })
    .then(r => {
        console.log("Response status:", r.status);
        console.log("Content-Type:", r.headers.get('content-type'));
        return r;
    })
    .then(async r => {
        // Manejar respuestas no-JSON (500 HTML) o JSON
        let data;
        const ct = r.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
            data = await r.json();
        } else {
            data = await r.text();
        }

        // Si recibimos texto, mostrarlo directamente
        if (typeof data === 'string') {
            mostrar("Error del servidor: " + data);
            return;
        }

        if (data.message === "C贸digo enviado") {
            document.getElementById("cajaCodigo").style.display = "block";
            mostrar("C贸digo enviado por SMS. Revisa tu tel茅fono.", false);
            
            // Guardamos temporalmente el n煤mero
            sessionStorage.setItem("telefono_login", telefono);
            sessionStorage.setItem("idEmpresa_login", idEmpresa);
            return;
        }

        // Mapear c贸digos de error del backend a mensajes amigables
        const err = data.error || "unknown";
        let msg = "Error enviando c贸digo.";
        if (err === "no_encontrado") {
            window.location.href = `/paciente/empresa/${idEmpresa}/alta?telefono=${telefono}`;
            return;
        }
        else if (err === "twilio_no_config") {
            msg = "Servicio SMS no configurado. Contacta al administrador.";
        }
        else if (err === "sms_send_error") {
            msg = "No se pudo enviar el SMS. Intenta m谩s tarde.";
        }
        else if (err === "whatsapp_no_config") {
            msg = "Servicio WhatsApp no configurado. Contacta al administrador.";
        }
        else if (err === "whatsapp_send_error") {
            msg = "No se pudo enviar el mensaje por WhatsApp. Intenta m谩s tarde.";
        }
        else if (err === "server_exception") {
            msg = "Error interno del servidor. Contacta al administrador.";
        }

        mostrar(msg);
    })
    
    .catch(err => {
        console.error(err);
        mostrar("Error enviando c贸digo.");
    });
}

function validarCodigo() {
    let codigo = document.getElementById("codigo").value.trim();
    let telefono = sessionStorage.getItem("telefono_login");
    let idEmpresa = sessionStorage.getItem("idEmpresa_login");

    if (!codigo || codigo.length !== 6) {
        mostrar("C贸digo inv谩lido");
        return;
    }

    fetch("/paciente/validar_codigo_empresa", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({telefono, codigo, idEmpresa})
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            // Redirigir al men煤 del paciente de esta empresa
            window.location.href = `/empresa/${idEmpresa}/paciente/menu`;
        } else {
            mostrar("C贸digo incorrecto o expirado.");
        }
    })
    .catch(err => {
        console.error(err);
        mostrar("Error validando c贸digo.");
    });
}

function mostrar(msg, error = true){
    let div = document.getElementById("mensaje");
    div.style.display = "block";
    div.textContent = msg;

    div.className = error ? "error-message" : "success-message";
}

</script>

</body>
</html>
